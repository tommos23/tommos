{{- $img := .Page.Resources.GetMatch (.Get "src") -}}
{{- $alt := .Get "alt" | default "" -}}
{{- $caption := .Get "caption" | default "" -}}

{{- if $img -}}
  {{- $tinyw := $img.Fill "320x320 webp" -}}
  {{- $smallw := $img.Fill "640x640 webp" -}}
  {{- $mediumw := $img.Fill "1024x1024 webp" -}}
  {{- $largew := $img.Fill "1600x1600 webp" -}}
  
  {{- $tiny := $img.Fill "320x320" -}}
  {{- $small := $img.Fill "640x640" -}}
  {{- $medium := $img.Fill "1024x1024" -}}
  {{- $large := $img.Fill "1600x1600" -}}

  <figure>
    <picture>
      <source type="image/webp"
              srcset="{{ $tinyw.RelPermalink }} 320w,
                      {{ $smallw.RelPermalink }} 640w,
                      {{ $mediumw.RelPermalink }} 1024w,
                      {{ $largew.RelPermalink }} 1600w"
              sizes="(max-width: 640px) 100vw, (max-width: 1024px) 90vw, 1024px">
      <source type="{{ $img.MediaType }}"
              srcset="{{ $tiny.RelPermalink }} 320w,
                      {{ $small.RelPermalink }} 640w,
                      {{ $medium.RelPermalink }} 1024w,
                      {{ $large.RelPermalink }} 1600w"
              sizes="(max-width: 640px) 100vw, (max-width: 1024px) 90vw, 1024px">
      <img src="{{ $medium.RelPermalink }}" 
           alt="{{ $alt }}"
           width="{{ $medium.Width }}"
           height="{{ $medium.Height }}"
           loading="lazy"
           decoding="async">
    </picture>
    {{- if $caption -}}
      <figcaption>{{ $caption | markdownify }}</figcaption>
    {{- end -}}
  </figure>
{{- else -}}
  <p style="color: red;">Error: Image "{{ .Get "src" }}" not found in page bundle</p>
{{- end -}}
